-- [[ –º–µ–Ω—è–π —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ]]
getgenv().Optimization = {
    state = true, -- –≤–∫–ª/–≤—ã–∫–ª
    hide_screen = true, -- –≤—ã–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ—Ä–∏—Å–æ–≤–∫—É –≥—Ä–∞—Ñ–∏–∫–∏, –±—É—Å—Ç–∏—Ç –∂–µ—Å—Ç–æ—á–∞–π—à–µ —Ñ–ø—Å (–≤–∫–ª/–≤—ã–∫–ª)
    fps = 3
};

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä—Ö–æ–ø–∞ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
getgenv().ServerHopSettings = {
    interval = 15, -- 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ö–æ–ø–∞
    last_hop_time = os.time() - 15, -- –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ö–æ–ø–∞
    use_random_offset = true, -- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ —Ä–∞–Ω–¥–æ–º–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —Ö–æ–ø–æ–º
    min_players = 2, -- –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞
    max_players = 10, -- –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞
    server_distribution = true, -- —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã –ø–æ —Ä–∞–∑–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–∞–º
    debug = true -- –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
};

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∏—Ñ—Ç–æ–≤
getgenv().CacheSettings = {
    global_cache_file = "global_rifts_cache.json", -- —Ñ–∞–π–ª –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∞
    local_cache_file = "local_rifts_cache.json", -- —Ñ–∞–π–ª –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∞
    cache_ttl = 900, -- –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (15 –º–∏–Ω—É—Ç)
    precision = 1, -- —Ç–æ—á–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π)
    use_shared_cache = true -- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â–∏–π –∫–µ—à –º–µ–∂–¥—É –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏
};

if getgenv().Optimization.state then
    if setfpscap ~= nil then setfpscap(getgenv().Optimization.fps); end
    UserSettings().GameSettings.MasterVolume = 0;
    settings().Rendering.QualityLevel = "Level01";
    game:GetService("RunService"):Set3dRenderingEnabled(not getgenv().Optimization.hide_screen);
end

local players = game:GetService("Players");
local local_player = players.LocalPlayer;
local http_service = game:GetService("HttpService");
local teleport_service = game:GetService("TeleportService");

-- –•–æ–ø–Ω—É–ª –ª–∏ —Å–∫—Ä–∏–ø—Ç —É–∂–µ (–¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Ö–æ–ø–æ–≤)
local is_hopping = false

-- –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –º–µ–∂–∞–∫–∫–∞—É–Ω—Ç–Ω–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
if not _G.RiftFinderCache then
    _G.RiftFinderCache = {
        rifts = {},
        last_cleanup = os.time()
    }
end

-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª—è—é –æ–∂–∏–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ nil
local rifts
local function getRifts()
    local rendered = workspace:FindFirstChild("Rendered")
    if rendered then
        rifts = rendered:FindFirstChild("Rifts")
    end
    return rifts ~= nil
end

-- –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ä–∏—Ñ—Ç—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
repeat
    task.wait(2) -- –û–∂–∏–¥–∞–Ω–∏–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    print("Waiting for Rifts to load...")
until getRifts()

-- –°–∏—Å—Ç–µ–º–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤–µ–±—Ö—É–∫–æ–≤
local local_cache_file = getgenv().CacheSettings.local_cache_file
local global_cache_file = getgenv().CacheSettings.global_cache_file
local local_rifts_cache = {}
local global_rifts_cache = {}

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ ID —Ä–∏—Ñ—Ç–∞
local function createRiftId(rift_name, position, time_expires, luck_value)
    local precision = getgenv().CacheSettings.precision
    local rounded_x = math.floor(position.X * (10^precision)) / (10^precision)
    local rounded_y = math.floor(position.Y * (10^precision)) / (10^precision)
    local rounded_z = math.floor(position.Z * (10^precision)) / (10^precision)
    
    -- –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è, –æ–∫—Ä—É–≥–ª—è—è –¥–æ –º–∏–Ω—É—Ç—ã
    local expiry_minute = math.floor(time_expires / 60) * 60
    
    return string.format("%s_%.1f_%.1f_%.1f_%d_%s", 
        rift_name, 
        rounded_x, 
        rounded_y, 
        rounded_z, 
        expiry_minute,
        luck_value or "noluck"
    )
end

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
local function safeReadFile(filepath)
    if not isfile or not isfile(filepath) then
        return nil
    end
    
    local success, content = pcall(function()
        return readfile(filepath)
    end)
    
    if success then
        local parsed_success, data = pcall(function()
            return http_service:JSONDecode(content)
        end)
        
        if parsed_success then
            return data
        end
    end
    
    return nil
end

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞
local function safeWriteFile(filepath, data)
    if not writefile then return false end
    
    local success, encoded = pcall(function()
        return http_service:JSONEncode(data)
    end)
    
    if success then
        pcall(function()
            writefile(filepath, encoded)
        end)
        return true
    end
    
    return false
end

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞
local function cleanCache()
    local current_time = os.time()
    local ttl = getgenv().CacheSettings.cache_ttl
    
    -- –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
    local new_local_cache = {}
    for rift_id, timestamp in pairs(local_rifts_cache) do
        if current_time - timestamp < ttl then
            new_local_cache[rift_id] = timestamp
        end
    end
    local_rifts_cache = new_local_cache
    
    -- –û—á–∏—â–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à
    local new_global_cache = {}
    for rift_id, timestamp in pairs(global_rifts_cache) do
        if current_time - timestamp < ttl then
            new_global_cache[rift_id] = timestamp
        end
    end
    global_rifts_cache = new_global_cache
    
    -- –û—á–∏—â–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
    if _G.RiftFinderCache then
        local new_shared_cache = {}
        for rift_id, timestamp in pairs(_G.RiftFinderCache.rifts) do
            if current_time - timestamp < ttl then
                new_shared_cache[rift_id] = timestamp
            end
        end
        _G.RiftFinderCache.rifts = new_shared_cache
        _G.RiftFinderCache.last_cleanup = current_time
    end
    
    -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–µ—à–∏
    safeWriteFile(local_cache_file, local_rifts_cache)
    
    if getgenv().CacheSettings.use_shared_cache then
        safeWriteFile(global_cache_file, global_rifts_cache)
    end
    
    local local_count = 0
    for _ in pairs(local_rifts_cache) do local_count = local_count + 1 end
    
    local global_count = 0
    for _ in pairs(global_rifts_cache) do global_count = global_count + 1 end
    
    print("Cache cleaned: Local cache size:", local_count, "Global cache size:", global_count)
end

-- –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
local loaded_local = safeReadFile(local_cache_file)
if loaded_local then
    local_rifts_cache = loaded_local
end

-- –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à
if getgenv().CacheSettings.use_shared_cache then
    local loaded_global = safeReadFile(global_cache_file)
    if loaded_global then
        global_rifts_cache = loaded_global
    end
end

-- –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∏—Ñ—Ç–∞ –≤ –∫–µ—à–µ
local function isRiftCached(rift_id)
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
    if local_rifts_cache[rift_id] then
        return true
    end
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª–æ–≤—ã–π –∫–µ—à
    if getgenv().CacheSettings.use_shared_cache and global_rifts_cache[rift_id] then
        return true
    end
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º _G –æ–±—ä–µ–∫—Ç –¥–ª—è –º–µ–∂–∞–∫–∫–∞—É–Ω—Ç–Ω–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
    if _G.RiftFinderCache and _G.RiftFinderCache.rifts[rift_id] then
        return true
    end
    
    return false
end

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∏—Ñ—Ç–∞
local function cacheRift(rift_id)
    local current_time = os.time()
    
    -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
    local_rifts_cache[rift_id] = current_time
    
    -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª–æ–≤—ã–π –∫–µ—à
    if getgenv().CacheSettings.use_shared_cache then
        global_rifts_cache[rift_id] = current_time
        safeWriteFile(global_cache_file, global_rifts_cache)
    end
    
    -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ _G –¥–ª—è –º–µ–∂–∞–∫–∫–∞—É–Ω—Ç–Ω–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
    if _G.RiftFinderCache then
        _G.RiftFinderCache.rifts[rift_id] = current_time
    end
    
    -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
    safeWriteFile(local_cache_file, local_rifts_cache)
    
    -- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∞ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
    if _G.RiftFinderCache and current_time - _G.RiftFinderCache.last_cleanup > 300 then
        cleanCache()
    end
end

-- –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –∫–µ—à–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
task.spawn(function()
    while true do
        task.wait(300) -- 5 –º–∏–Ω—É—Ç
        print("Scheduled cache cleanup...")
        cleanCache()
    end
end)

local whitelisted_eggs = { -- —Ç–µ–ø–µ—Ä—å —Ç—É—Ç –º–µ–Ω—è–µ—à—å –≤–µ–±—Ö—É–∫–∏ –ù–ê –ö–ê–ñ–î–û–ï –Ø–ô–¶–û/–°–£–ù–î–£–ö, –≤ luck —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –≤ –∫–∞–≤—ã—á–∫–∞—Ö –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ—à—å –º–Ω–æ–∂–∏—Ç–µ–ª—å —É–¥–∞—á–∏
    ["rainbow-egg"] = {
        webhook = "https://discord.com/api/webhooks/1372211950334906499/_fEmj8oGQ8x4v2kUYeweBlpGdoaCoJ6tIs59BfsBUBeApzBax76neHeWmYbxZyDAXU5f",
        role_id = "", -- ID —Ä–æ–ª–∏ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
        luck = { "x25" },
        name = "Rainbow Egg"
    },
    ["nightmare-egg"] = {
        webhook = "https://discord.com/api/webhooks/1372212037693866014/agJ1yjXiLDXZAuiJISTd4kr3cCuCRsXuxRVmx42YqrIXJ9qpUSe7wpM9U3-MTYblwQsk",
        role_id = "",
        luck = { "x25" },
        name = "Nightmare Egg"
    },
    ["void-egg"] = {
        webhook = "https://discord.com/api/webhooks/1372211864133701642/nn8YJOJs5BleUhifO-hA0UNI3nIqnzBlHrhFSTOiibxQBGBjjvMTL8bY9jTciCbjUlNL",
        role_id = "",
        luck = { "x25" },
        name = "Void Egg"
    },
    ["royal-chest"] = {
        webhook = "https://discord.com/api/webhooks/1372212119629463753/oVq84wDoSWkyoraVjkYsdsxTBRx1bL3Ui1vUv8eAN7FJNb0Fil27LCOEF5BUT-ZP4Fx_",
        role_id = "1371539682713796648",
        name = "Royal Chest"
    },
    ["bubble-rift"] = {
        webhook = "https://discord.com/api/webhooks/1372211352357179432/7E34K-TjOiIBvKwze6XcknyeMZr73rN77eGJ1iinqCs6noRMvmNIwm3rGH4_OemmtSah",
        role_id = "",
        name = "Bubble Rifft"
    },
    ["mining-egg"] = {
        webhook = "https://discord.com/api/webhooks/1372211772303609896/PinWw2B_ppgV8JsspqCsfFEx8kbK1ozGZEywUFaO5KjTndjm3FvpE_l6V2XO3_XH_amI",
        role_id = "",
        luck = { "x25" },
        name = "Mining Egg"
    },
    ["cyber-egg"] = {
        webhook = "https://discord.com/api/webhooks/1372211676283273336/Xxiew3FwtHoGld268v6yI46y0AlS9rVlKbjDIIPWLAugNRCO-aN_G7MkXd0z9auQksud",
        role_id = "1371540351361482802",
        luck = { "x25" },
        name = "Cyber Egg"
    },
    ["dice-rift"] = {
        webhook = "https://discord.com/api/webhooks/1372211539167281244/CcP3FgYKV-sZAMmtrtu4z5J5wJJ-SCGUAfavJSvyOc-L4uciHxvIiVmsnCMnpUabrb2s",
        role_id = "1371539732022169601",
        name = "Dice Rift"
    },
    ["underworld-1"] = {
        webhook = "https://discord.com/api/webhooks/1371074619645235243/u_0v1rptBiojPUlQSSwaA7zoIbryx-4qEK1JZaaJkKd82T9Mo4VWMN3hyD6beszMNcYY",
        role_id = "1371510979116007545",
        luck = { "x25" },
        name = "Underworld 1"
    },
    ["underworld-2"] = {
        webhook = "https://discord.com/api/webhooks/1371074619645235243/u_0v1rptBiojPUlQSSwaA7zoIbryx-4qEK1JZaaJkKd82T9Mo4VWMN3hyD6beszMNcYY",
        role_id = "1371510979116007545",
        luck = { "x25" },
        name = "Underworld 2"
    },
    ["underworld-3"] = {
        webhook = "https://discord.com/api/webhooks/1371074619645235243/u_0v1rptBiojPUlQSSwaA7zoIbryx-4qEK1JZaaJkKd82T9Mo4VWMN3hyD6beszMNcYY",
        role_id = "1371510979116007545",
        luck = { "x25" },
        name = "Underworld 3"
    }
};

local spam_messages = {
    "Best Rift Finder = ƒ£ƒ£/ easyrift üî•",
    "Underworld Egg is found! ƒ£ƒ£/ easyrift üî•",
    "Best Pet Shop = ƒ£ƒ£/ easyrift üî•",
    "REACH THE LEADERBOARDS USING ƒüƒü/ easyrift üèÜ",
    "SECRETS GIVE-AWAY HAPPENING ƒ£ƒ£/ easyrift üåü",
    "X25 LUCK RIFTS AT ƒ£ƒ£/ easyrift üçÄ",
    "UNDERWORLD RIFT ƒ£ƒ£/ easyrift ü•ö"
};

local join_link = string.format('https://www.roblox.com/games/start?placeId=%d&launchData=%s', game.PlaceId, game.JobId);

local parse_time = function(text)
    text = string.lower(string.gsub(text, "^%s*(.-)%s*$", "%1"));
    local number, unit = string.match(text, "(%d+)%s*(%a+)");
    if number == nil or unit == nil then 
        return 0;
    end
    
    number = tonumber(number);
    
    if string.find(unit, "second") then
        return number;
    elseif string.find(unit, "minute") then
        return number * 60;
    elseif string.find(unit, "hour") then
        return number * 3600;
    else
        return 0;
    end
end

local time_to_discorddate = function(time_)
    return string.format("<t:%d:R>", time_);
end

local request = (syn ~= nil and syn.request) or (http ~= nil and http.request) or (fluxus ~= nil and fluxus.request) or http_request or request;

-- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è notify –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–∏–Ω–≥–æ–≤
local notify = function(webhook, data)
    local response = request({
        Url = webhook, 
        Body = http_service:JSONEncode(data), 
        Method = "POST", 
        Headers = { ['content-type'] = "application/json" }
    });
    print("Discord webhook response:", response.StatusCode, response.StatusMessage);
    return response;
end

-- –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä-—Ö–æ–ø —Å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
local function serverhop()
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ö–æ–ø–∞
    if is_hopping then
        print("SKIP: Already hopping to a new server")
        return
    end
    
    -- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –º—ã –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ö–æ–ø–∞
    is_hopping = true
    
    if getgenv().ServerHopSettings.debug then
        print("SERVER HOP: Starting serverhop process")
    end
    
    -- –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    if getgenv().ServerHopSettings.use_random_offset then
        local random_delay = math.random(1, 3)
        if getgenv().ServerHopSettings.debug then
            print("SERVER HOP: Random delay before hop:", random_delay)
        end
        wait(random_delay)
    end
    
    -- –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ö–æ–ø–∞
    getgenv().ServerHopSettings.last_hop_time = os.time()
    
    -- –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–µ—Ä–≤–µ—Ä–æ–≤
    local file = "serverhop_history.json";
    local history = {};
    local current_time = os.time();
    
    -- –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if pcall(function() return readfile(file) end) then
        pcall(function()
            history = http_service:JSONDecode(readfile(file))
            
            -- –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏
            local new_history = {};
            for serverId, jt in pairs(history) do
                if current_time - jt < 300 then -- 5 –º–∏–Ω—É—Ç
                    new_history[serverId] = jt;
                end
            end
            
            history = new_history;
        end)
    end
    
    -- –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–æ–≤
    local page_size = 100
    local page_offset = (local_player.UserId % 5) * page_size
    local sort_order = (local_player.UserId % 2 == 0) and "Asc" or "Desc"
    
    if getgenv().ServerHopSettings.debug then
        print("SERVER HOP: Requesting servers with params:", 
              "offset =", page_offset,
              "sort_order =", sort_order)
    end
    
    -- –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
    local success, result = pcall(function()
        return request({
            Url = string.format(
                "https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=%s&limit=%d&cursor=%s&excludeFullGames=true", 
                game.PlaceId,
                sort_order,
                page_size,
                page_offset > 0 and tostring(page_offset) or ""
            )
        })
    end)
    
    if success and result then
        local body = http_service:JSONDecode(result.Body)
        
        if getgenv().ServerHopSettings.debug then
            print("SERVER HOP: Got response with", #(body.data or {}), "servers")
        end
        
        if body and body.data and #body.data > 0 then
            local suitable_servers = {}
            
            -- –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Å–µ—Ä–≤–µ—Ä—ã
            for _, server in pairs(body.data) do
                if server.playing >= getgenv().ServerHopSettings.min_players and 
                   server.playing <= getgenv().ServerHopSettings.max_players and
                   server.id ~= game.JobId and 
                   not history[server.id] then
                    
                    local priority = 50 - server.playing -- –ß–µ–º –º–µ–Ω—å—à–µ –∏–≥—Ä–æ–∫–æ–≤, —Ç–µ–º –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                    for i = 1, priority do
                        table.insert(suitable_servers, server)
                    end
                end
            end
            
            if getgenv().ServerHopSettings.debug then
                print("SERVER HOP: Found", #suitable_servers, "suitable weighted servers")
            end
            
            -- –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Å–µ—Ä–≤–µ—Ä—ã, –≤—ã–±–∏—Ä–∞–µ–º –æ–¥–∏–Ω —Å–ª—É—á–∞–π–Ω–æ
            if #suitable_servers > 0 then
                -- –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –¥–ª—è –±–æ–ª—å—à–µ–π —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
                for i = #suitable_servers, 2, -1 do
                    local j = math.random(1, i)
                    suitable_servers[i], suitable_servers[j] = suitable_servers[j], suitable_servers[i]
                end
                
                local selected_server = suitable_servers[math.random(1, #suitable_servers)]
                
                -- –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –≤ –∏—Å—Ç–æ—Ä–∏—é
                history[selected_server.id] = current_time
                writefile(file, http_service:JSONEncode(history))
                
                if getgenv().ServerHopSettings.debug then
                    print("SERVER HOP: Selected server with", selected_server.playing, "players, ID:", selected_server.id)
                end
                
                -- –¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º—Å—è –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
                teleport_service:TeleportToPlaceInstance(game.PlaceId, selected_server.id, local_player)
                
                -- –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –ª–∏ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è
                task.delay(10, function()
                    if game.JobId == selected_server.id then
                        print("SERVER HOP: Successfully teleported to new server")
                    else
                        print("SERVER HOP: Teleport failed or still pending")
                        is_hopping = false -- –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Ö–æ–ø–∞
                    end
                end)
                
                return
            else
                if getgenv().ServerHopSettings.debug then
                    print("SERVER HOP: No suitable servers found, trying generic teleport")
                end
            end
        else
            if getgenv().ServerHopSettings.debug then
                print("SERVER HOP: No servers in API response, trying generic teleport")
            end
        end
    else
        if getgenv().ServerHopSettings.debug then
            print("SERVER HOP: Error fetching servers:", result)
            print("Trying generic teleport")
        end
    end
    
    -- –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Å–µ—Ä–≤–µ—Ä—ã, –ø—Ä–æ—Å—Ç–æ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º—Å—è –≤ –∏–≥—Ä—É
    teleport_service:Teleport(game.PlaceId, local_player)
    
    -- –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥, –µ—Å–ª–∏ —Ç–µ–ª–µ–ø–æ—Ä—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
    task.delay(10, function()
        is_hopping = false
    end)
end

task.spawn(function() -- anti afk
    for _,v in pairs(getconnections(local_player.Idled)) do v:Disable() end
    for _,v in pairs(getconnections(game:GetService("UserInputService").WindowFocused)) do v:Disable() end
    for _,v in pairs(getconnections(game:GetService("UserInputService").WindowFocusReleased)) do v:Disable() end
end)

task.spawn(function()
    local channel = game:GetService("TextChatService"):WaitForChild("TextChannels"):WaitForChild("RBXGeneral");
    local time = 1;
    while task.wait() do
        channel:SendAsync(spam_messages[Random.new(tick()):NextInteger(1, #spam_messages)]);
        time += 2;
        if time > 6 then
            time = 1;
        end

        task.wait(time);
    end
end)

-- –¢–∞–π–º–µ—Ä —Å–µ—Ä–≤–µ—Ä—Ö–æ–ø–∞ 
task.spawn(function()
    -- –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º —Ö–æ–ø–æ–º
    task.wait(5)
    
    while true do
        -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—â–µ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
        task.wait(1)
        
        -- –ï—Å–ª–∏ –º—ã –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ö–æ–ø–∞ –∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
        if not is_hopping then
            local current_time = os.time()
            local elapsed_time = current_time - getgenv().ServerHopSettings.last_hop_time
            
            if elapsed_time >= getgenv().ServerHopSettings.interval then
                if getgenv().ServerHopSettings.debug then
                    print("SERVER HOP TIMER: Interval reached -", elapsed_time, "seconds passed")
                end
                serverhop()
            end
        end
    end
end)

do
    local rifts_found = 0 -- —Å—á–µ—Ç—á–∏–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–∏—Ñ—Ç–æ–≤
    local rifts_sent = 0  -- —Å—á–µ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤–µ–±—Ö—É–∫–æ–≤
    
    for _, rift in pairs(rifts:GetChildren()) do
        if not rift:IsA("Model") or not whitelisted_eggs[rift.Name] then
            continue;
        end
        
        rifts_found = rifts_found + 1
        
        local data = whitelisted_eggs[rift.Name];
        local luck = "None";
        local gui
        
        -- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –Ω–∞ nil –∏ –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        local display = rift:FindFirstChild("Display")
        if display then
            gui = display:FindFirstChildOfClass("SurfaceGui")
            if data.luck ~= nil then
                if gui == nil then
                    repeat 
                        task.wait(0.5)
                        gui = display:FindFirstChildOfClass("SurfaceGui")
                    until gui ~= nil or task.wait(5) -- —Ç–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥
                end
                
                if gui and gui:FindFirstChild("Icon") and gui.Icon:FindFirstChild("Luck") then
                    if not table.find(data.luck, gui.Icon.Luck.Text) then
                        continue
                    end
                    luck = gui.Icon.Luck.Text
                else
                    continue -- –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                end
            end
        else
            continue -- –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç Display
        end
        
        if not gui or not gui:FindFirstChild("Timer") then
            continue -- –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç —Ç–∞–π–º–µ—Ä–∞
        end

        -- –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∏—Ñ—Ç–∞
        local expiry_time = os.time() + parse_time(gui.Timer.Text);
        
        -- –°–æ–∑–¥–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π ID —Ä–∏—Ñ—Ç–∞ —Å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
        local position = rift:GetPivot().Position
        local rift_id = createRiftId(rift.Name, position, expiry_time, luck)
        
        -- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —ç—Ç–æ—Ç —Ä–∏—Ñ—Ç —É–∂–µ –Ω–∞–π–¥–µ–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ
        if isRiftCached(rift_id) then
            print("Rift already reported:", rift_id)
            continue
        end
        
        local discord_time = time_to_discorddate(expiry_time);
        local height = math.floor(position.Y) - 4;
        
        -- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º Action Row —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
        local message = {
            ['content'] = data.role_id and data.role_id ~= "" and ("<@&" .. data.role_id .. ">") or "",
            ['allowed_mentions'] = {
                ['parse'] = {"roles"}
            },
            ['embeds'] = {
                { 
                    ['title'] = string.format("%s has been found!", data.name), 
                    ['fields'] = {
                        {
                            ['name'] = "‚è≤ Expires in",
                            ['value'] = discord_time,
                            ['inline'] = true
                        },
                        {
                            ['name'] = "üìè Height",
                            ['value'] = string.format("`%d`", height),
                            ['inline'] = true
                        },
                        {
                            ['name'] = "üë§ Players",
                            ['value'] = string.format("`%d`", #players:GetPlayers()),
                            ['inline'] = true
                        },
                        {
                            ['name'] = "üçÄ Luck",
                            ['value'] = string.format("`%s`", luck)
                        }
                    },
                    ['color'] = 4508791,
                    ['footer'] = {
                        ['text'] = "gg/easyrift ‚Ä¢ " .. os.date("%H:%M", os.time())
                    }
                }
            },
            ['components'] = {
                {
                    ['type'] = 1,
                    ['components'] = {
                        {
                            ['type'] = 2,
                            ['label'] = "Join",
                            ['style'] = 5,
                            ['url'] = join_link
                        }
                    }
                }
            }
        };

        -- –ö–µ—à–∏—Ä—É–µ–º —Ä–∏—Ñ—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤–µ–±—Ö—É–∫–∞
        cacheRift(rift_id)
        
        -- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ–±—Ö—É–∫
        notify(data.webhook, message);
        rifts_sent = rifts_sent + 1
        
        -- –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ –≤–µ–±—Ö—É–∫–æ–≤
        task.wait(0.5)
    end
    
    print("Rifts found:", rifts_found, "Webhooks sent:", rifts_sent)
end

-- –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä—Ö–æ–ø —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥, –µ—Å–ª–∏ –ø–æ –∫–∞–∫–∏–º-—Ç–æ –ø—Ä–∏—á–∏–Ω–∞–º –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π
task.spawn(function()
    task.wait(30)
    if not is_hopping and os.time() - getgenv().ServerHopSettings.last_hop_time >= 30 then
        print("SERVER HOP: Forced hop after 30 seconds")
        serverhop()
    end
end)

-- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∏–∫–∞ –∏–≥—Ä–æ–π
game:GetService("CoreGui"):FindFirstChild("RobloxPromptGui"):FindFirstChild("promptOverlay").ChildAdded:Connect(function(child)
    print("SERVER HOP: Kick detected, hopping to a new server")
    if not is_hopping then
        serverhop()
    end
end)

-- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π —Ö–æ–ø –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
task.spawn(function()
    task.wait(8) -- –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    print("SERVER HOP: Initial hop after script load")
    if not is_hopping then
        serverhop()
    end
end)
